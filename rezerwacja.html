<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Rezerwacja stolika</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    h2 {
      color: #666;
      margin-bottom: 30px;
    }

    .restaurant-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: inline-block;
    }

    .user-form {
      background: #f1f3f4;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: left;
    }

    .user-form h3 {
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: #007bff;
    }

    .time-selector {
      margin: 30px 0;
      padding: 20px;
      background: #f1f3f4;
      border-radius: 10px;
    }

    .time-selector h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .time-slider-container {
      position: relative;
      margin: 20px 0;
    }

    .time-slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    .time-slider::-webkit-slider-thumb {
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .time-slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #007bff;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .time-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }

    .current-time {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
      margin: 15px 0;
    }

    .seats-container {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 10px;
      justify-content: center;
      margin: 30px 0;
    }

    .seat {
      width: 60px;
      height: 60px;
      background-color: #28a745;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      position: relative;
    }

    .seat:hover:not(.occupied) {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .seat.occupied {
      background-color: #dc3545;
      cursor: not-allowed;
    }

    .seat.selected {
      background-color: #007bff;
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0,123,255,0.5);
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #333;
    }

    .legend-free { background-color: #28a745; }
    .legend-occupied { background-color: #dc3545; }
    .legend-selected { background-color: #007bff; }

    #confirmBtn {
      margin-top: 30px;
      padding: 15px 30px;
      font-size: 18px;
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #confirmBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    #confirmBtn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background 0.3s ease;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .no-seats-message {
      color: #856404;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }

    .success-message {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
      
      .seats-container {
        grid-template-columns: repeat(3, 60px);
      }
    }
  </style>
</head>
<body>
  <a href="javascript:history.back()" class="back-btn">← Powrót</a>
  
  <div class="container">
    <h1>Wybierz miejsce i godzinę</h1>
    <div class="restaurant-info">
      <h2 id="restaurantName">Ładowanie...</h2>
      <div id="restaurantDetails"></div>
    </div>

    <div class="user-form">
      <h3>Dane do rezerwacji</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="userLastname">Nazwisko *</label>
          <input type="text" id="userLastname" placeholder="Wprowadź nazwisko" required>
        </div>
        <div class="form-group">
          <label for="userEmail">Email *</label>
          <input type="email" id="userEmail" placeholder="twoj@email.com" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="userPhone">Telefon (opcjonalnie - 9 cyfr)</label>
          <input type="tel" id="userPhone" placeholder="123456789" maxlength="9" pattern="[0-9]{9}" title="Wprowadź dokładnie 9 cyfr">
        </div>
      </div>
    </div>

    <div class="time-selector">
      <h3>Wybierz godzinę rezerwacji</h3>
      <div class="time-slider-container">
        <input type="range" id="timeSlider" class="time-slider" min="0" max="4" value="0" step="1">
        <div class="time-labels">
          <span>12:00</span>
          <span>14:00</span>
          <span>16:00</span>
          <span>18:00</span>
          <span>20:00</span>
        </div>
      </div>
      <div class="current-time" id="currentTime">12:00</div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color legend-free"></div>
        <span>Wolne</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-occupied"></div>
        <span>Zajęte</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-selected"></div>
        <span>Wybrane</span>
      </div>
    </div>

    <div id="errorMessage" class="error-message" style="display: none;"></div>
    <div id="successMessage" class="success-message" style="display: none;"></div>
    <div id="loadingMessage" style="margin: 20px 0;">
      <div class="loading"></div> Ładowanie miejsc...
    </div>
    <div id="noSeatsMessage" class="no-seats-message" style="display: none;">
      Brak dostępnych miejsc dla wybranej godziny.
    </div>
    
    <div class="seats-container" id="seatsContainer" style="display: none;"></div>
    <button id="confirmBtn" style="display: none;" disabled>Zatwierdź rezerwację</button>
  </div>

  <script>
    const seatsContainer = document.getElementById('seatsContainer');
    const confirmBtn = document.getElementById('confirmBtn');
    const restaurantNameEl = document.getElementById('restaurantName');
    const restaurantDetailsEl = document.getElementById('restaurantDetails');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const noSeatsMessage = document.getElementById('noSeatsMessage');
    const timeSlider = document.getElementById('timeSlider');
    const currentTimeEl = document.getElementById('currentTime');
    
    // Elementy formularza użytkownika
    const userLastnameInput = document.getElementById('userLastname');
    const userEmailInput = document.getElementById('userEmail');
    const userPhoneInput = document.getElementById('userPhone');

    // Pobierz parametry URL
    const params = new URLSearchParams(window.location.search);
    const restaurantName = params.get("restaurant");
    const restaurantId = params.get("restaurant_id");

    // Mapowanie ID na nazwy restauracji
    const restaurantNames = {
      1: "Restauracja Polska",
      2: "Pizza Max",
      3: "Sushi Sakura",
      4: "Burger House",
      5: "Pierogarnia Krakowska",
      6: "Wawel Bistro",
      7: "Kraków Grill",
      8: "Cafe Rynek"
    };

    // Mapowanie nazw restauracji na ID (zachowane dla kompatybilności)
    const restaurantMapping = {
      "Restauracja Polska": 1,
      "Pizza Max": 2,
      "Sushi Sakura": 3,
      "Burger House": 4,
      "Pierogarnia Krakowska": 5,
      "Wawel Bistro": 6,
      "Kraków Grill": 7,
      "Cafe Rynek": 8
    };

    const timeSlots = ['12:00', '14:00', '16:00', '18:00', '20:00'];
    let currentRestaurantId = restaurantId || restaurantMapping[restaurantName] || 1;
    let selectedSeats = [];
    let currentTimeSlot = timeSlots[0];

    // Walidacja pola telefonu - tylko cyfry, maksymalnie 9 (identyczna jak w restaurant.php)
    userPhoneInput.addEventListener('input', function(e) {
      // Usuń wszystkie znaki oprócz cyfr
      let value = e.target.value.replace(/[^0-9]/g, '');
      
      // Ogranicz do 9 cyfr
      if (value.length > 9) {
        value = value.substring(0, 9);
      }
      
      e.target.value = value;
    });

    // Blokuj wklejanie nieprawidłowych znaków
    userPhoneInput.addEventListener('paste', function(e) {
      e.preventDefault();
      let paste = (e.clipboardData || window.clipboardData).getData('text');
      let cleanPaste = paste.replace(/[^0-9]/g, '').substring(0, 9);
      e.target.value = cleanPaste;
    });

    // Funkcja do pobrania nazwy restauracji z serwera
    function loadRestaurantInfo() {
      fetch(`restaurants.php`)
        .then(res => res.json())
        .then(restaurants => {
          const restaurant = restaurants.find(r => r.id == currentRestaurantId);
          if (restaurant) {
            restaurantNameEl.textContent = restaurant.restaurant_name;
            restaurantDetailsEl.innerHTML = `
              <div><strong>Miasto:</strong> ${restaurant.city}</div>
              ${restaurant.address ? `<div><strong>Adres:</strong> ${restaurant.address}</div>` : ''}
              ${restaurant.opening_hours ? `<div><strong>Godziny otwarcia:</strong> ${restaurant.opening_hours}</div>` : ''}
            `;
          } else {
            // Fallback do mapowania lokalnego
            const name = restaurantNames[currentRestaurantId] || 'Nieznana restauracja';
            restaurantNameEl.textContent = name;
            restaurantDetailsEl.innerHTML = `<div><strong>ID restauracji:</strong> ${currentRestaurantId}</div>`;
          }
        })
        .catch(err => {
          console.error('Błąd podczas ładowania danych restauracji:', err);
          // Fallback do lokalnego mapowania
          const name = restaurantNames[currentRestaurantId] || 'Nieznana restauracja';
          restaurantNameEl.textContent = name;
          restaurantDetailsEl.innerHTML = `<div><strong>ID restauracji:</strong> ${currentRestaurantId}</div>`;
        });
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
      loadingMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }

    function showNoSeats() {
      noSeatsMessage.style.display = 'block';
      seatsContainer.style.display = 'none';
      confirmBtn.style.display = 'none';
    }

    function hideNoSeats() {
      noSeatsMessage.style.display = 'none';
    }

    function validateForm() {
      const lastname = userLastnameInput.value.trim();
      const email = userEmailInput.value.trim();
      const phone = userPhoneInput.value.trim();
      
      if (!lastname) {
        showError('Proszę wprowadzić nazwisko.');
        return false;
      }
      
      if (!email) {
        showError('Proszę wprowadzić adres email.');
        return false;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Proszę wprowadzić prawidłowy adres email.');
        return false;
      }
      
      // Walidacja telefonu - jeśli podany, musi mieć dokładnie 9 cyfr
      if (phone && phone.length !== 9) {
        showError('Telefon musi składać się z dokładnie 9 cyfr.');
        return false;
      }
      
      if (phone && !/^[0-9]{9}$/.test(phone)) {
        showError('Telefon może zawierać tylko cyfry.');
        return false;
      }
      
      return true;
    }

    function updateConfirmButton() {
      const hasSeats = selectedSeats.length > 0;
      const hasValidData = userLastnameInput.value.trim() && userEmailInput.value.trim();
      
      confirmBtn.disabled = !hasSeats || !hasValidData;
      confirmBtn.textContent = selectedSeats.length > 0 
        ? `Zatwierdź rezerwację (${selectedSeats.length} miejsc na ${currentTimeSlot})` 
        : 'Zatwierdź rezerwację';
    }

    function updateTimeDisplay() {
      const sliderValue = parseInt(timeSlider.value);
      currentTimeSlot = timeSlots[sliderValue];
      currentTimeEl.textContent = currentTimeSlot;
      loadSeats();
    }

    function loadSeats() {
      loadingMessage.style.display = 'block';
      seatsContainer.style.display = 'none';
      confirmBtn.style.display = 'none';
      hideMessages();
      hideNoSeats();
      selectedSeats = [];

      fetch(`get_seats.php?restaurant_id=${currentRestaurantId}&time_slot=${currentTimeSlot}:00`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            showError(data.error);
            return;
          }

          loadingMessage.style.display = 'none';

          if (data.length === 0) {
            showNoSeats();
            return;
          }

          seatsContainer.style.display = 'grid';
          confirmBtn.style.display = 'inline-block';
          seatsContainer.innerHTML = '';

          data.forEach((seatData) => {
            const seat = document.createElement('div');
            seat.classList.add('seat');
            if (seatData.is_occupied) {
              seat.classList.add('occupied');
            }

            seat.dataset.seatNumber = seatData.seat_number;
            seat.textContent = seatData.seat_number;

            seat.addEventListener('click', () => {
              if (!seat.classList.contains('occupied')) {
                const seatNumber = parseInt(seat.dataset.seatNumber);
                
                if (seat.classList.contains('selected')) {
                  seat.classList.remove('selected');
                  selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                } else {
                  seat.classList.add('selected');
                  selectedSeats.push(seatNumber);
                }
                
                updateConfirmButton();
              }
            });

            seatsContainer.appendChild(seat);
          });

          updateConfirmButton();
        })
        .catch(err => {
          console.error('Błąd:', err);
          showError('Nie udało się załadować miejsc. Sprawdź połączenie z serwerem.');
        });
    }

    // Event listenery
    timeSlider.addEventListener('input', updateTimeDisplay);
    
    // Walidacja w czasie rzeczywistym
    userLastnameInput.addEventListener('input', updateConfirmButton);
    userEmailInput.addEventListener('input', updateConfirmButton);

    // Obsługa zatwierdzania rezerwacji
    confirmBtn.addEventListener('click', () => {
      if (!validateForm()) {
        return;
      }
      
      if (selectedSeats.length === 0) {
        showError('Wybierz przynajmniej jedno miejsce.');
        return;
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Rezerwuję...';

      const reservationData = {
        selectedSeats: selectedSeats,
        restaurant_id: currentRestaurantId,
        time_slot: currentTimeSlot + ':00',
        nazwisko: userLastnameInput.value.trim(),
        email: userEmailInput.value.trim(),
        phone: userPhoneInput.value.trim() || null
      };

      fetch('update_seats.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(reservationData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showSuccess(`Sukces! ${data.message}`);
          // Wyczyść formularz
          userLastnameInput.value = '';
          userEmailInput.value = '';
          userPhoneInput.value = '';
          selectedSeats = [];
          loadSeats(); // Przeładuj miejsca
        } else {
          showError(`Błąd: ${data.error}`);
          confirmBtn.disabled = false;
          updateConfirmButton();
        }
      })
      .catch(err => {
        console.error('Błąd:', err);
        showError('Wystąpił błąd podczas rezerwacji. Spróbuj ponownie.');
        confirmBtn.disabled = false;
        updateConfirmButton();
      });
    });

    // Inicjalizacja
    loadRestaurantInfo();
    loadSeats();
  </script>
</body>
</html>